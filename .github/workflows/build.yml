name: Build packages
on: push

jobs:
  runtime:
    runs-on: ubuntu-latest

    container:
      image: ubuntu:22.04

    strategy:
      matrix:
        include:
          - library: libdispatch-5.5
            download: https://github.com/apple/swift-corelibs-libdispatch/archive/refs/tags/swift-5.5-RELEASE.tar.gz
            orig: libdispatch_5.5
          - library: libobjc2-2.1.20220927
            download: https://github.com/gnustep/libobjc2/archive/35ac9bc072e652e8bac9cd501f94d3b089b8f9a2.tar.gz
            orig: libobjc2_2.1.20220927

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y devscripts wget equivs

    - name: Download sources
      run: |
        wget -nc ${{ matrix.download }} -O ${{ matrix.orig }}.orig.tar.gz

    - name: Install build dependencies
      working-directory: ${{ matrix.library }}/
      run: |
        mk-build-deps -i -t "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y"
        rm -f *.deb *.buildinfo *.changes

    - name: Build packages
      working-directory: ${{ matrix.library }}/
      run: |
        tar -xvzf ../${{ matrix.orig }}.orig.tar.gz --strip-components=1
        debuild

    - name: Upload packages
      uses: actions/upload-artifact@v3
      with:
        name: debian
        path: |
          *.deb
          *.dsc

  gnustep-make:
    needs: runtime

    runs-on: ubuntu-latest

    container:
      image: ubuntu:22.04

    strategy:
      matrix:
        include:
          - library: gnustep-make-2.9.0
            download: https://github.com/gnustep/tools-make/releases/download/make-2_9_0/gnustep-make-2.9.0.tar.gz
            orig: gnustep-make_2.9.0

    steps:
    - uses: actions/checkout@v3

    - uses: actions/download-artifact@v3
      with:
        name: debian
        
    - name: Install dependencies
      run: |
        dpkg -i libdispatch0_5.5-1_amd64.deb
        dpkg -i libdispatch-dev_5.5-1_amd64.deb
        dpkg -i libobjc2_2.1.20220927-1_amd64.deb
        dpkg -i libobjc2-dev_2.1.20220927-1_amd64.deb

        apt-get update
        apt-get install -y devscripts wget equivs

    - name: Download sources
      run: |
        wget -nc ${{ matrix.download }} -O ${{ matrix.orig }}.orig.tar.gz

    - name: Install build dependencies
      working-directory: ${{ matrix.library }}/
      run: |
        mk-build-deps -i -t "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y"
        rm -f *.deb *.buildinfo *.changes

    - name: Build packages
      working-directory: ${{ matrix.library }}/
      run: |
        tar -xvzf ../${{ matrix.orig }}.orig.tar.gz --strip-components=1
        debuild

    - name: Upload packages
      uses: actions/upload-artifact@v3
      with:
        name: debian
        path: |
          *.deb
          *.dsc
